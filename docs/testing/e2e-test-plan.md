# FerryTransit E2E テスト計画

## 目的と範囲
- Playwright を用いて公開サイト・状態保持機能・管理画面・横断要素（i18n/テーマ/オフライン等）を網羅的にカバーする。
- Firebase Storage / Ship Status API / Google Maps などの外部依存はすべてスタブ化し、決定的なデータで検証する。
- 主要ユーザーフロー単位で Page Object / Helper を導入し、冗長なケースを抑えながら失敗時の診断性を高める。
- `src/tests/e2e/fixtures` と `src/tests/e2e/utils` を新設し、テストに必要なスタブ・ユーティリティを集約する。

## 事前準備タスク
- `playwright.config.ts` を拡張し、`globalSetup` でフィクスチャ読み込みや環境変数切り替え（Firebase 無効化・API スタブエンドポイント設定）を行う。
- Firebase プラグインをテスト専用モック (`plugins/firebase.mock.client.ts` など) へ切り替え、Storage/Functions 呼び出しをローカルデータ返却に置換する。
- Ship Status API・ニュース JSON などのレスポンスを `/src/tests/e2e/fixtures/api/*.json` として整備し、Playwright の `page.route` で差し込む。
- ユーザー／管理者それぞれの `storageState` を保存して初期ログインコストを削減する。
- Google Maps iframe を安定化するため `page.route` で `about:blank` へ差し替え、`--disable-gpu` などのブラウザ起動オプションを設定する。

## テストスイート計画

### 公開サイト
- **ホーム／時刻表 (`/`)**
  - 初期表示（出発・到着未選択メッセージ）
  - 港選択〜結果表示（ソート、欠航・臨時便バッジ、お気に入りボタン）
  - 日付変更・履歴ストア連動・地図トグル・モーダル表示
  - エラーフィクスチャ挿入時のエラーバナー表示
- **乗換案内 (`/transit`)**
  - 直行／乗換ルート検索とソート切り替え（出発順・到着順・料金・乗換回数）
  - 到着指定モード・お気に入り／履歴登録・詳細モーダル・ルートマップ
  - 欠航データ適用時の除外ロジック確認
- **運航状況 (`/status`)**
  - 正常データ（船ごとのステータス／警告強調）
  - アラート付きデータ・更新ボタン・最終更新時刻
  - API 失敗スタブ時のエラーバナー表示
- **料金表 (`/fare`)**
  - タブ切替（隠岐汽船／内航船）とテーブル表示
  - レスポンシブ検証（モバイル）
  - 料金マスター取得失敗時のエラーステート
- **カレンダー (`/calendar`)**
  - 機能フラグ ON/OFF での UI 切替
  - 月移動・祝日／繁忙期／特別運航バッジ
  - 月別リスト・データ取得エラー表示
- **ニュース (`/news`, `/news/:id`)**
  - カテゴリフィルタ・ピン留め・ページネーション
  - ローディング／空リスト／エラー状態
  - 詳細ページ（パンくず・Markdown 表示・404 分岐）
- **お気に入り (`/favorites`)**
  - `localStorage` シードを用いた表示・並び替え
  - 編集モード・削除・最大数制限メッセージ
- **検索履歴 (`/history`)**
  - 履歴表示／個別削除／一括削除モーダル
  - `storage` イベント同期の擬似検証
- **設定 (`/settings`)**
  - 言語切替（URL プレフィックスと翻訳の切替）
  - テーマ変更（ライト／ダーク）と公開ページへの反映
  - 地図設定トグルとトップページでの反映確認
  - データ管理（キャッシュ削除トースト）検証
- **その他公開ページ**
  - グローバルナビゲーションのリンク遷移と 404 ページ
  - ブラウザバックや複数デバイス幅でのレイアウトスモーク

### 管理画面
- **ログイン**
  - 正常ログイン・エラーコード別メッセージ
  - 未認証アクセス時の `/admin/login` リダイレクト
- **ダッシュボード**
  - 統計カード・人気航路・最近のアクティビティ表示
- **時刻表管理**
  - 一覧・フィルタ・詳細モーダル・CSV インポート UI
- **運航アラート管理**
  - 新規作成・公開状態変更・プレビュー
- **料金管理**
  - 路線選択→運賃編集→保存モーダルのフロー
- **ニュース管理**
  - 一覧（フィルタ・公開ステータス）と作成／編集画面（バリデーション・プレビュー・下書き保存）
- **ユーザー／設定／データ管理**
  - 一覧表示・代表アクション（ロック／ロール変更／バックアップ）
- **共通**
  - サイドバー開閉・レスポンシブ・Toast 表示・ログアウト処理

### 横断テスト
- **i18n**
  - 主要ページで `ja → en → ja` 切替時に URL・翻訳が正しく変わるか確認。
- **テーマ**
  - テーマ変更に伴う body クラス・主 UI の配色切替を検証。
- **オフライン／キャッシュ**
  - `localStorage` / IndexedDB のキャッシュ利用（オフラインモードで `/data/*.json` を返す）を確認。
- **アクセシビリティ**
  - 主要フォーム・モーダルのフォーカストラップと ARIA 属性のスモークチェック。
- **回帰スモーク**
  - ルーティング網羅・404・ブラウザバック・複数デバイス幅での描画を短時間で確認。

## フェーズ別導入
1. **フェーズ1**: 公開トップフロー（時刻表・乗換・運航状況・料金）＋言語／テーマ切替を優先実装し、主要機能の回帰検出能力を確保する。
2. **フェーズ2**: 状態保持機能（お気に入り・履歴・設定）とニュース周辺を追加し、ユーザーデータ周りの品質を担保する。
3. **フェーズ3**: 管理画面のログイン〜各 CRUD フローを網羅し、運用チーム向け機能の信頼性を高める。
4. **フェーズ4**: 横断テスト（オフライン・アクセシビリティ・レスポンシブ）と CI 並列実行最適化を実施し、継続的インテグレーションへ組み込む。

## 運用・保守指針
- フィクスチャデータは仕様変更に合わせて `docs/IMPLEMENTATION_STATUS.md` と同期し、レビュー対象とする。
- 管理画面 API 実装完了後は Firebase Emulator もしくは仮想サーバを用いた統合テストへ段階的に移行する。
- 新機能追加時は「ユースケース → ユニット／コンポーネント → E2E」の三層テストを PR チェックリストへ追加する。
- CI 上では `npm run test:e2e` をスモークとして実行し、Playwright レポート・トレースを成果物として保存する。

