# フェーズ 4 - ビジネスロジックの詳細実装

## 実装スケジュール（合計: 約9-13日）

| タスク | 期間 | 優先度 | 状態 |
|--------|------|--------|------|
| 料金表示システム | 2-3日 | 高 | ✅ 完了 |
| 特殊日対応 | 2-3日 | 高 | ✅ 完了 |
| オフライン対応 | 2-3日 | 高 | ✅ 完了 |
| お気に入り機能 | 2日 | 中 | ✅ 完了 |
| 検索履歴 | 1-2日 | 中 | ✅ 完了 |

## 新規作成ファイル（フェーズ4）

```
src/
├── pages/
│   ├── fare.vue          # 料金表ページ ✅
│   └── calendar.vue      # 運航カレンダーページ ✅
├── composables/
│   ├── useFareDisplay.ts ✅
│   ├── useHolidayCalendar.ts ✅
│   └── useOfflineStorage.ts ✅
├── stores/
│   ├── fare.ts ✅
│   ├── offline.ts ✅
│   ├── favorite.ts ✅
│   └── history.ts ✅ (2025年6月23日追加)
├── types/
│   ├── fare.ts ✅
│   ├── holiday.ts ✅
│   ├── favorite.ts ✅
│   └── history.ts ✅ (2025年6月23日追加)
└── data/
    ├── fare-master.json  # 料金マスターデータ ✅
    └── holidays.json     # 祝日データ ✅
```

## 実装詳細

### 4.1 料金表示システム ✅

- 料金マスターデータの作成
- 料金表示ロジックの実装
- 料金表ページの作成
- 国際化対応（日本語・英語）
- ユニットテストの実装

### 4.2 特殊日・祝日対応 ✅

- 日本の祝日カレンダー実装
- 特殊ダイヤの表示機能
- 運航カレンダーページの作成
- 繁忙期・特別運航情報の表示
- ユニットテストの実装

### 4.3 オフライン対応 ✅

- ローカルストレージによるキャッシュ
- IndexedDB によるデータ永続化
- オフライン状態の UI 対応
- TTL（有効期限）管理
- オフライン検出とフォールバック
- ユニットテストの実装

### 4.4 お気に入り機能 ✅

- お気に入りルートの保存・管理
- お気に入り港の保存・管理（最大5港）
- 並び替え機能（ドラッグ&ドロップ対応）
- LocalStorageによる永続化
- タブ間の同期機能
- ユニットテストの実装

### 4.5 検索履歴機能 ✅

- 検索履歴の自動保存
- 履歴からの再検索機能
- 最大50件の履歴を保持
- 30日経過した古い履歴を自動削除
- タブ間の同期機能
- ユニットテストの実装

## 追加改善項目 ✅

### 乗換案内機能の改善

- 料金マスターデータを使用した正確な料金計算
- 繁忙期料金の自動適用
- JSTタイムゾーンの修正
- AngularJS版に準拠したUI実装
  - 経路パネルの配色（border-blue-600）
  - 港の行の背景色（#D8ECF3）
  - 船舶の左ボーダー（double 10px）
  - 船舶ごとの色分け（赤、黄、青、ティール）

## フェーズ 4 完了サマリー 🎉

フェーズ 4 のすべてのタスクが正常に完了しました。これにより、FerryTransitのNuxt3版は以下の機能を完全にサポートします：

- **料金計算**: マスターデータに基づく正確な料金表示と繁忙期料金対応
- **祝日・特殊日**: 日本の祝日カレンダーと特別運航情報の表示
- **オフライン対応**: ローカルストレージによるデータキャッシュと自動フォールバック
- **ユーザー体験**: お気に入りルート、検索履歴、UIの統一性
- **国際化**: 日本語・英語の完全対応