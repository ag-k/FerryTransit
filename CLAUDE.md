# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際の Claude Code (claude.ai/code)への指針を提供します。

## プロジェクト概要

FerryTransit は、島根県隠岐諸島のフェリー時刻表と航路情報システムです。このアプリケーションは各港間のフェリースケジュールを表示し、日本語と英語の両方をサポートしています。

## 会話ガイドライン

- 常に日本語で会話する
- コード修正後は必ずビルドが通ることを確認する（`npm run build`）
- 関連するユニットテストも実行して動作を確認する（`npm run test:unit`）
- 変更によりユニットテストの修正が必要な場合は、テストも併せて修正する
- 該当機能にユニットテストが存在しない場合は、新規にユニットテストを実装する

**現在、AngularJS 版から Nuxt3 版への移行作業が進行中です。**

## プロジェクト構成

```
FerryTransit/
├── index.html                 # AngularJS版（現行）
├── js/                        # AngularJS版のソースコード
├── ferry-transit-nuxt/        # Nuxt3版（開発中）
├── MIGRATION_PLAN.md          # 移行計画書
└── PHASE1_TASKS.md           # フェーズ1タスクリスト
```

- Nuxt3 版の開発を行う
- AngularJS 版は更新せず、参照に留めること

## 技術スタック

### AngularJS 版（現行）

- **フロントエンド**: AngularJS 1.7.9 (レガシーバージョン)
- **言語**: TypeScript (ES5 にコンパイル)
- **UI**: Bootstrap 3.4.1 with Angular UI Bootstrap
- **データストレージ**: SQLite データベースから JSON にエクスポート
- **サーバー**: CORS ヘッダー付きで JSON を提供する PHP

### Nuxt3 版（開発中）

- **フレームワーク**: Nuxt 3.17.5 + Vue 3
- **言語**: TypeScript (strict mode)
- **UI**: Tailwind CSS v4.1.10（Bootstrap 5 から移行中）
- **状態管理**: Pinia
- **国際化**: @nuxtjs/i18n
- **スタイル**: Sass/SCSS + Tailwind CSS
- **ターゲット**: Web + iOS/Android (Capacitor 予定)

## 開発コマンド

### AngularJS 版

npm スクリプトが定義されていないため、開発は手動プロセスに従います：

#### TypeScript コンパイル

TypeScript ファイルは保存時にコンパイルするよう設定されています。プロジェクトで使用：

- `js/controller.ts` → `js/controller.js`
- `js/timepicker-ctrl.ts` → `js/timepicker-ctrl.js`

#### データ更新

フェリー時刻表データを更新するには：

```bash
# update_timetable.sqlでSQLコマンドを編集
# 更新スクリプトを実行
./update_timetable.sh
```

### Nuxt3 版

```bash
cd ferry-transit-nuxt

# 開発サーバー起動
npm run dev

# ビルド
npm run build

# プレビュー
npm run preview

# 型チェック
npm run typecheck

# ユニットテスト
npm run test:unit

# リント
npm run lint
```

## アーキテクチャ概要

### データフロー

1. **ソースデータ**: `timetable.sqlite`に保存されたフェリースケジュール情報
2. **データエクスポート**: `update_timetable.sh`経由で SQLite → JSON
3. **API**: `timetable.php`が CORS ヘッダー付きで JSON を提供
4. **フロントエンド**: AngularJS コントローラーがデータを取得して表示

### コアコンポーネント

#### AngularJS 版

**メインコントローラー (`js/controller.ts`)**
- フェリースケジュール表示を管理
- 言語切り替え（ja/en）を処理
- 日付ベースのフィルタリングを実装
- 港/船情報のモーダルダイアログを制御

#### Nuxt3 版

**ストア構成**
- `ferry.ts`: フェリーと港の情報管理
- `timetable.ts`: 時刻表データの管理
- `ui.ts`: UI状態（言語、テーマ等）の管理

**主要コンポーネント**
- `DatePicker.vue`: 日付選択コンポーネント
- `PortSelector.vue`: 港選択コンポーネント
- `ShipModal.vue`: 船舶情報モーダル
- `AlertComponent.vue`: 運航アラート表示

**データ構造**
時刻表データには以下が含まれます：

- 港の接続（西郷、菱浦、別府、来居、本土七類、本土境港）
- フェリーサービス（フェリーおき、フェリーしらしま、フェリーくにが、フェリーどうぜん）
- 日時付きスケジュール情報
- サービスアラートと例外

### 主要機能の実装

#### AngularJS 版
- **多言語対応**: Angular Translate を使用
- **日付フィルタリング**: カスタム日付ピッカー実装
- **地図統合**: Google Maps API で港の場所を表示
- **レスポンシブデザイン**: Bootstrap 3 ベースのレイアウト

#### Nuxt3 版
- **多言語対応**: @nuxtjs/i18n を使用（日本語・英語対応）
- **日付フィルタリング**: Vue コンポーネントによる日付ピッカー
- **地図統合**: Google Maps API 統合（実装済み）
- **レスポンシブデザイン**: Tailwind CSS によるモバイルファースト設計

## 重要な考慮事項

### 共通

1. **手動データ更新**: スケジュール更新には手動の SQL 編集とスクリプト実行が必要
2. **CORS 設定**: PHP エンドポイントにはクロスオリジンリクエスト用の CORS ヘッダーが含まれる
3. **日付処理**: 日本のカレンダーの考慮事項とタイムゾーン処理が重要

### AngularJS 版

1. **レガシーフレームワーク**: アクティブにメンテナンスされていない AngularJS 1.x を使用
2. **ブラウザ互換性**: 古いブラウザもサポート

### Nuxt3 版

1. **移行作業中**: AngularJS 版と並行して開発中
2. **モダンブラウザ対象**: ES2015+をサポートするブラウザが必要
3. **SSR/SSG 対応**: サーバーサイドレンダリングに対応
4. **UIフレームワーク移行中**: Bootstrap 5 から Tailwind CSS へ段階的に移行
5. **テスト駆動開発**: Vitest によるユニットテストを実装

## 移行状況

### 完了済み

#### フェーズ 1（基盤構築）
- ✅ プロジェクト基盤の構築
- ✅ 依存関係のセットアップ
- ✅ 型定義の作成
- ✅ 国際化対応
- ✅ 基本レイアウトとルーティング

#### フェーズ 2（データ層）
- ✅ Pinia ストアの実装
- ✅ API エンドポイントの実装
- ✅ データ取得ロジックの移植

#### フェーズ 3（UI/UX）
- ✅ 主要ページの実装（ホーム、時刻表、乗換案内、運航状況）
- ✅ 共通コンポーネントの実装
- 🚧 Bootstrap 5 から Tailwind CSS への移行（進行中）
- 🚧 レスポンシブデザインの改善（進行中）

### 次のステップ（フェーズ 4）

- ビジネスロジックの詳細実装
  - 料金計算の詳細実装
  - 特殊日（祝日・イベント）対応
  - オフライン対応の強化
- 追加機能の実装
  - お気に入りルート保存
  - 検索履歴
  - PWA 対応

詳細は`MIGRATION_PLAN.md`を参照してください。

## 現在の課題

1. **テストカバレッジ**: 一部のコンポーネントでテストが不足
2. **UIフレームワーク移行**: Bootstrap 5 から Tailwind CSS への完全な移行が必要
3. **パフォーマンス**: 大量データ表示時の最適化が必要

## 開発時の注意事項

1. **型安全性**: TypeScript の strict mode を維持し、any 型の使用を避ける
2. **テスト**: 新機能追加時は必ずユニットテストを作成する
3. **国際化**: すべてのテキストは i18n 経由で表示する
4. **アクセシビリティ**: WCAG 2.1 AA 準拠を目指す
5. **レスポンシブ**: モバイルファーストで設計する