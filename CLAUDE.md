# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際の Claude Code (claude.ai/code)への指針を提供します。

## プロジェクト概要

FerryTransit は、島根県隠岐諸島のフェリー時刻表と航路情報システムです。このアプリケーションは各港間のフェリースケジュールを表示し、日本語と英語の両方をサポートしています。

## 会話ガイドライン

- 常に日本語で会話する
- コード修正後は必ずビルドが通ることを確認する（`npm run build`）
- 関連するユニットテストも実行して動作を確認する（`npm run test:unit`）
- 変更によりユニットテストの修正が必要な場合は、テストも併せて修正する
- 該当機能にユニットテストが存在しない場合は、新規にユニットテストを実装する
- 進捗は CLAUDE.md に記載すること

**現在、AngularJS 版から Nuxt3 版への移行作業が進行中です。**

## プロジェクト構成

```
FerryTransit/
├── index.html                 # AngularJS版（現行）
├── js/                        # AngularJS版のソースコード
├── ferry-transit-nuxt/        # Nuxt3版（開発中）
├── MIGRATION_PLAN.md          # 移行計画書
└── PHASE1_TASKS.md           # フェーズ1タスクリスト
```

- Nuxt3 版の開発を行う
- AngularJS 版は更新せず、参照に留めること

## 技術スタック

### AngularJS 版（現行）

- **フロントエンド**: AngularJS 1.7.9 (レガシーバージョン)
- **言語**: TypeScript (ES5 にコンパイル)
- **UI**: Bootstrap 3.4.1 with Angular UI Bootstrap
- **データストレージ**: SQLite データベースから JSON にエクスポート
- **サーバー**: CORS ヘッダー付きで JSON を提供する PHP

### Nuxt3 版（開発中）

- **フレームワーク**: Nuxt 3.17.5 + Vue 3
- **言語**: TypeScript (strict mode)
- **UI**: Tailwind CSS v4.1.10
- **状態管理**: Pinia
- **国際化**: @nuxtjs/i18n
- **スタイル**: Sass/SCSS + Tailwind CSS
- **ターゲット**: Web + iOS/Android (Capacitor 予定)

## 開発コマンド

### AngularJS 版

npm スクリプトが定義されていないため、開発は手動プロセスに従います：

#### TypeScript コンパイル

TypeScript ファイルは保存時にコンパイルするよう設定されています。プロジェクトで使用：

- `js/controller.ts` → `js/controller.js`
- `js/timepicker-ctrl.ts` → `js/timepicker-ctrl.js`

#### データ更新

フェリー時刻表データを更新するには：

```bash
# update_timetable.sqlでSQLコマンドを編集
# 更新スクリプトを実行
./update_timetable.sh
```

### Nuxt3 版

```bash
cd ferry-transit-nuxt

# 開発サーバー起動
npm run dev

# ビルド
npm run build

# プレビュー
npm run preview

# 型チェック
npm run typecheck

# ユニットテスト
npm run test:unit

# リント
npm run lint
```

## アーキテクチャ概要

### データフロー

1. **ソースデータ**: `timetable.sqlite`に保存されたフェリースケジュール情報
2. **データエクスポート**: `update_timetable.sh`経由で SQLite → JSON
3. **API**: `timetable.php`が CORS ヘッダー付きで JSON を提供
4. **フロントエンド**: AngularJS コントローラーがデータを取得して表示

### コアコンポーネント

#### AngularJS 版

**メインコントローラー (`js/controller.ts`)**

- フェリースケジュール表示を管理
- 言語切り替え（ja/en）を処理
- 日付ベースのフィルタリングを実装
- 港/船情報のモーダルダイアログを制御

#### Nuxt3 版

**ストア構成**

- `ferry.ts`: フェリーと港の情報管理
- `timetable.ts`: 時刻表データの管理
- `ui.ts`: UI 状態（言語、テーマ等）の管理

**主要コンポーネント**

- `DatePicker.vue`: 日付選択コンポーネント
- `PortSelector.vue`: 港選択コンポーネント
- `ShipModal.vue`: 船舶情報モーダル
- `AlertComponent.vue`: 運航アラート表示

**データ構造**
時刻表データには以下が含まれます：

- 港の接続（西郷、菱浦、別府、来居、本土七類、本土境港）
- フェリーサービス（フェリーおき、フェリーしらしま、フェリーくにが、フェリーどうぜん）
- 日時付きスケジュール情報
- サービスアラートと例外

### 主要機能の実装

#### AngularJS 版

- **多言語対応**: Angular Translate を使用
- **日付フィルタリング**: カスタム日付ピッカー実装
- **地図統合**: Google Maps API で港の場所を表示
- **レスポンシブデザイン**: Bootstrap 3 ベースのレイアウト

#### Nuxt3 版

- **多言語対応**: @nuxtjs/i18n を使用（日本語・英語対応）
- **日付フィルタリング**: Vue コンポーネントによる日付ピッカー
- **地図統合**: Google Maps API 統合（実装済み）
- **レスポンシブデザイン**: Tailwind CSS によるモバイルファースト設計

## 重要な考慮事項

### 共通

1. **手動データ更新**: スケジュール更新には手動の SQL 編集とスクリプト実行が必要
2. **CORS 設定**: PHP エンドポイントにはクロスオリジンリクエスト用の CORS ヘッダーが含まれる
3. **日付処理**: 日本のカレンダーの考慮事項とタイムゾーン処理が重要

### AngularJS 版

1. **レガシーフレームワーク**: アクティブにメンテナンスされていない AngularJS 1.x を使用
2. **ブラウザ互換性**: 古いブラウザもサポート

### Nuxt3 版

1. **移行作業中**: AngularJS 版と並行して開発中
2. **モダンブラウザ対象**: ES2015+をサポートするブラウザが必要
3. **SSR/SSG 対応**: サーバーサイドレンダリングに対応
4. **UI フレームワーク**: Tailwind CSS を採用（Bootstrap は不使用）
5. **テスト駆動開発**: Vitest によるユニットテストを実装

## 移行状況

### 完了済み

#### フェーズ 1（基盤構築）

- ✅ プロジェクト基盤の構築
- ✅ 依存関係のセットアップ
- ✅ 型定義の作成
- ✅ 国際化対応
- ✅ 基本レイアウトとルーティング

#### フェーズ 2（データ層）

- ✅ Pinia ストアの実装
- ✅ API エンドポイントの実装
- ✅ データ取得ロジックの移植

#### フェーズ 3（UI/UX）

- ✅ 主要ページの実装（ホーム、時刻表、乗換案内、運航状況）
- ✅ 共通コンポーネントの実装
- ✅ Tailwind CSS の導入と実装
- ✅ レスポンシブデザインの改善

### 次のステップ（フェーズ 4 - ビジネスロジックの詳細実装）

#### 4.1 料金表示システム（2-3日）
- 料金マスターデータの作成
- 料金表示ロジックの実装
- 料金表ページの作成

#### 4.2 特殊日・祝日対応（2-3日）
- 日本の祝日カレンダー実装
- 特殊ダイヤの表示機能
- 運航カレンダーページの作成

#### 4.3 オフライン対応（2-3日）
- ローカルストレージによるキャッシュ
- IndexedDB によるデータ永続化
- オフライン状態の UI 対応

#### 4.4 追加機能（3-4日）
- お気に入りルート機能
- 検索履歴機能
- ホーム画面のカスタマイズ

詳細は`MIGRATION_PLAN.md`を参照してください。

## 現在の課題

1. **テストカバレッジ**: 一部のコンポーネントでテストが不足
   - Tailwind CSS のクラスがテスト環境で認識されない
   - `$fetch` のモック不足による Store テストの失敗
2. **パフォーマンス**: 大量データ表示時の最適化が必要
3. **レスポンシブデザイン**: モバイル表示の更なる改善が必要

## 開発時の注意事項

1. **型安全性**: TypeScript の strict mode を維持し、any 型の使用を避ける
2. **テスト**: 新機能追加時は必ずユニットテストを作成する
3. **国際化**: すべてのテキストは i18n 経由で表示する
4. **アクセシビリティ**: WCAG 2.1 AA 準拠を目指す
5. **レスポンシブ**: モバイルファーストで設計する

## フェーズ 4 実装詳細

### 実装スケジュール（合計: 約9-13日）

| タスク | 期間 | 優先度 |
|--------|------|--------|
| 料金表示システム | 2-3日 | 高 |
| 特殊日対応 | 2-3日 | 高 |
| オフライン対応 | 2-3日 | 高 |
| お気に入り機能 | 2日 | 中 |
| 検索履歴 | 1-2日 | 中 |

### 新規作成ファイル（フェーズ4）

```
ferry-transit-nuxt/
├── pages/
│   ├── fare.vue          # 料金表ページ ✅
│   └── calendar.vue      # 運航カレンダーページ ✅
├── composables/
│   ├── useFareDisplay.ts ✅
│   ├── useHolidayCalendar.ts ✅
│   └── useOfflineStorage.ts ✅
├── stores/
│   ├── fare.ts ✅
│   ├── offline.ts ✅
│   ├── favorite.ts ✅
│   └── history.ts ✅ (2025年6月23日追加)
├── types/
│   ├── fare.ts ✅
│   ├── holiday.ts ✅
│   ├── favorite.ts ✅
│   └── history.ts ✅ (2025年6月23日追加)
└── data/
    ├── fare-master.json  # 料金マスターデータ ✅
    └── holidays.json     # 祝日データ ✅
```

## 技術的な変更履歴

### 2025年6月23日
- 検索履歴機能の実装（`stores/history.ts`）
- 最大50件の履歴保持、30日経過した履歴の自動削除機能
- タブ間同期機能の実装
- ユニットテストの作成と全テスト合格を確認
- 乗換案内機能の改善
  - 料金マスターデータを使用した正確な料金計算
  - JSTタイムゾーン対応の修正
  - AngularJS版に準拠したUI実装（配色、レイアウト、アイコン）
- データファイルの配置修正（public/dataディレクトリへ移動）
- フェーズ4の全タスク完了

### 2025年6月22日
- フェーズ 4 の実装を大幅に進捗
- 料金表示システムの完成（料金マスターデータ、表示ロジック、料金表ページ）
- 特殊日対応の完成（祝日データ、判定ロジック、運航カレンダーページ）
- オフライン対応の実装（LocalStorage によるキャッシュ、オフライン検出、フォールバック）
- 各機能のユニットテストを実装

### 2025年6月21日
- レスポンシブデザインの改善完了
- モバイルタッチターゲットを44x44px以上に拡大
- フェーズ4の詳細計画策定（PWAと予約機能を除外）

### 2025年6月20日
- Bootstrap 5 から Tailwind CSS への移行完了（コミット: 9fabbff）
- 当初の計画では Bootstrap 5 を使用予定だったが、より柔軟なスタイリングのため Tailwind CSS を採用
- すべてのコンポーネントで Tailwind CSS のユーティリティクラスを使用
- Bootstrap JavaScript コンポーネントは Vue 3 のネイティブ機能で実装

## フェーズ 4 実装状況（2025年6月23日更新）✅ 完了

### 完了済みタスク

1. **料金表示システム** ✅
   - 料金マスターデータの作成（`public/data/fare-master.json`）
   - 料金表示ロジックの実装（`composables/useFareDisplay.ts`）
   - 料金表ページの作成（`pages/fare.vue`）
   - 国際化対応（日本語・英語）
   - ユニットテストの実装

2. **特殊日対応** ✅
   - 祝日データの作成（`public/data/holidays.json`）
   - 祝日判定ロジックの実装（`composables/useHolidayCalendar.ts`）
   - 運航カレンダーページの作成（`pages/calendar.vue`）
   - 繁忙期・特別運航情報の表示
   - ユニットテストの実装

3. **オフライン対応** ✅
   - ストレージ管理の実装（`composables/useOfflineStorage.ts`）
   - オフラインストアの作成（`stores/offline.ts`）
   - LocalStorage を使用したデータキャッシュ
   - TTL（有効期限）管理
   - オフライン検出とフォールバック
   - ユニットテストの実装

4. **お気に入り機能** ✅（2025年6月22日完了）
   - お気に入りルートの保存・管理（`stores/favorite.ts`）
   - お気に入り港の保存・管理（最大5港）
   - 並び替え機能（ドラッグ&ドロップ対応）
   - LocalStorageによる永続化
   - タブ間の同期機能
   - ユニットテストの実装

5. **検索履歴機能** ✅（2025年6月23日完了）
   - 検索履歴の自動保存（`stores/history.ts`）
   - 履歴からの再検索機能
   - 最大50件の履歴を保持
   - 30日経過した古い履歴を自動削除
   - タブ間の同期機能
   - ユニットテストの実装
   - 型定義の作成（`types/history.ts`）

### 追加改善項目（2025年6月23日）✅

6. **乗換案内機能の改善**
   - 料金マスターデータを使用した正確な料金計算
   - 繁忙期料金の自動適用
   - JSTタイムゾーンの修正
   - AngularJS版に準拠したUI実装
     - 経路パネルの配色（border-blue-600）
     - 港の行の背景色（#D8ECF3）
     - 船舶の左ボーダー（double 10px）
     - 船舶ごとの色分け（赤、黄、青、ティール）

## フェーズ 4 完了サマリー 🎉

フェーズ 4 のすべてのタスクが正常に完了しました。これにより、FerryTransitのNuxt3版は以下の機能を完全にサポートします：

- **料金計算**: マスターデータに基づく正確な料金表示と繁忙期料金対応
- **祝日・特殊日**: 日本の祝日カレンダーと特別運航情報の表示
- **オフライン対応**: ローカルストレージによるデータキャッシュと自動フォールバック
- **ユーザー体験**: お気に入りルート、検索履歴、UIの統一性
- **国際化**: 日本語・英語の完全対応

### 残作業（UI実装）

フェーズ4のバックエンド機能は完了しましたが、以下のUI実装が残っています：
- お気に入り機能のUIコンポーネント
- 検索履歴のUIコンポーネント

これらはフェーズ5での実装を予定しています。
